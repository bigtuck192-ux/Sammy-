
<div [ngClass]="mainBorderClass()" class="bg-black/80 border-2 rounded-lg shadow-2xl shadow-purple-500/10 h-full flex flex-col overflow-hidden" [ngStyle]="{'border-color': currentTheme()?.primary + ' !important'}">

  <!-- Main Header -->
  <header class="bg-black/50 border-b-2 p-2 flex items-center justify-between" [style.borderColor]="currentTheme()?.primary">
    <div class="flex items-center gap-4">
      <h1 class="text-2xl font-bold" [ngClass]="mainTextColorClass()">s.m.u.v.e. 2.0</h1>
      <button (click)="toggleMainViewMode()" [ngClass]="mainHoverBgClass()" class="p-1 rounded-md" title="Toggle Main View"><i class="fas fa-sync-alt"></i></button>
      <button (click)="randomizeTheme()" [ngClass]="mainHoverBgClass()" class="p-1 rounded-md" title="Randomize Theme"><i class="fas fa-palette"></i></button>
      <button (click)="toggleEqPanel()" [ngClass]="mainHoverBgClass()" class="p-1 rounded-md" title="Toggle EQ Panel"><i class="fas fa-sliders-h"></i></button>
    </div>
    <div class="flex items-center gap-2">
      <button (click)="toggleChatbot()" [ngClass]="mainHoverBgClass()" class="p-1 rounded-md" title="Toggle Chatbot"><i class="fas fa-robot"></i></button>
      <span class="text-sm text-neutral-400">|</span>
      <button *ngIf="!authService.isAuthenticated()" (click)="mainViewMode.set('profile')" class="text-sm hover:underline">Login / Register</button>
      <div *ngIf="authService.isAuthenticated()" class="flex items-center gap-2">
        <span class="text-sm">Welcome, {{ authService.currentUser()?.artistName }}</span>
        <button (click)="mainViewMode.set('profile')" class="p-1 rounded-md" title="View Profile"><i class="fas fa-user-circle"></i></button>
        <button (click)="authService.logout()" class="text-sm hover:underline">Logout</button>
      </div>
    </div>
  </header>

  <!-- Hidden File Input -->
  <input type="file" #fileInput multiple (change)="handleFiles($event)" class="hidden">

  <!-- Main Content -->
  <main class="flex-grow flex overflow-hidden">
    <!-- Main View -->
    <div class="flex-grow relative overflow-y-auto">

      <!-- Player View -->
      <div *ngIf="mainViewMode() === 'player'" class="p-4 flex flex-col gap-4 h-full">
        <div class="flex items-center gap-2">
          <button (click)="fileInput.click()" class="bg-purple-600 hover:bg-purple-500 text-white font-bold py-2 px-4 rounded">
            Load Tracks
          </button>
          <span class="text-neutral-400 text-sm">{{ playlist().length }} tracks loaded</span>
        </div>

        <!-- Current Track Info -->
        <div *ngIf="currentPlayerTrack() as track" class="bg-neutral-800/50 rounded-lg p-4 flex gap-4 items-center">
          <img [src]="track.albumArtUrl || 'https://picsum.photos/100'" alt="Album Art" class="w-24 h-24 rounded-md object-cover">
          <div class="flex-grow">
            <h2 class="text-xl font-bold">{{ track.name }}</h2>
            <div class="flex items-center gap-4 mt-2">
              <button (click)="togglePlay()" class="text-3xl"><i [ngClass]="isPlaying() ? 'fa-pause-circle' : 'fa-play-circle'" class="fas"></i></button>
              <button (click)="playPrevious()" class="text-xl"><i class="fas fa-step-backward"></i></button>
              <button (click)="playNext()" class="text-xl"><i class="fas fa-step-forward"></i></button>
              <div class="flex-grow flex items-center gap-2">
                <span class="text-sm">{{ formatTime(currentTime()) }}</span>
                <input type="range" [value]="currentTime()" [max]="duration()" (input)="seek($event)" class="w-full">
                <span class="text-sm">{{ formatTime(duration()) }}</span>
              </div>
              <div class="flex items-center gap-2">
                <i class="fas fa-volume-down"></i>
                <input type="range" min="0" max="1" step="0.01" [value]="volume()" (input)="onVolumeChange($event)">
              </div>
            </div>
          </div>
        </div>
        <div *ngIf="!currentPlayerTrack()">
            <p class="text-center text-neutral-400">No track selected. Load tracks to begin.</p>
        </div>

        <!-- Playlist -->
        <div class="flex-grow overflow-y-auto">
            <div *ngFor="let track of playlist(); let i = index" 
                 (click)="currentTrackIndex.set(i)"
                 [ngClass]="{'bg-purple-600/30': i === currentTrackIndex()}"
                 class="p-2 rounded-md hover:bg-neutral-700 cursor-pointer flex justify-between items-center">
                <span>{{ track.name }}</span>
                <button (click)="imageToAnalyzeUrl.set(track.url); $event.stopPropagation()" class="text-xs text-neutral-400 hover:text-white">Analyze</button>
            </div>
        </div>
        <audio #mainAudioPlayer 
               (timeupdate)="onTimeUpdate()" 
               (loadedmetadata)="onLoadedMetadata()"
               (ended)="onTrackEnded()">
        </audio>
      </div>

      <!-- DJ Turntables View -->
      <div *ngIf="mainViewMode() === 'dj'" class="p-4 h-full flex flex-col gap-4">
          <!-- Controls Header -->
          <div class="flex justify-between items-center bg-neutral-900/50 p-2 rounded-md" [ngClass]="djBorderClass()">
              <button (click)="fileInput.click()" class="bg-fuchsia-600 hover:bg-fuchsia-500 text-white font-bold py-1 px-3 rounded text-sm">
                Load Tracks
              </button>
              <div class="flex items-center gap-3">
                  <button (click)="toggleRepeat()" [ngClass]="{'text-fuchsia-500': repeat()}" title="Repeat"><i class="fas fa-redo"></i></button>
                  <button (click)="toggleShuffle()" [ngClass]="{'text-fuchsia-500': shuffle()}" title="Shuffle"><i class="fas fa-random"></i></button>
              </div>
              <div class="flex items-center gap-2">
                <span class="text-sm">Mic</span>
                <input type="range" min="0" max="100" [(ngModel)]="micVolume" class="w-20">
              </div>
          </div>
          <!-- Decks -->
          <div class="flex-grow grid grid-cols-2 gap-4">
              <!-- Deck A -->
              <div class="bg-neutral-800/50 rounded-lg p-4 flex flex-col" [ngClass]="djBorderClass()">
                  <h3 [ngClass]="djTextColorClass()">Deck A</h3>
                  <div class="flex-grow flex items-center justify-center">
                    <div class="w-48 h-48 bg-neutral-900 rounded-full flex items-center justify-center relative">
                        <div #platterA class="w-44 h-44 bg-neutral-700 rounded-full border-4 border-neutral-600 cursor-grab active:cursor-grabbing" 
                             [style.transform]="scratchRotationA()"
                             (mousedown)="onScratchStart($event, 'A')" (touchstart)="onScratchStart($event, 'A')">
                             <div class="w-2 h-2 bg-red-500 rounded-full absolute top-2 left-1/2 -ml-1"></div>
                        </div>
                    </div>
                  </div>
                  <div class="mt-4">
                    <p class="text-sm truncate">{{ deckA().track?.name || 'No Track' }}</p>
                    <div class="flex items-center justify-center gap-4 mt-2">
                      <button (click)="toggleDeckPlay('A')" class="text-2xl"><i [ngClass]="deckA().isPlaying ? 'fa-pause' : 'fa-play'" class="fas"></i></button>
                      <button (click)="playNextOnDeck('A')" class="text-lg"><i class="fas fa-step-forward"></i></button>
                    </div>
                  </div>
                  <audio #audioPlayerA (ended)="onDeckTrackEnded('A')"></audio>
              </div>
              <!-- Deck B -->
              <div class="bg-neutral-800/50 rounded-lg p-4 flex flex-col" [ngClass]="djBorderClass()">
                  <h3 [ngClass]="djTextColorClass()">Deck B</h3>
                  <div class="flex-grow flex items-center justify-center">
                    <div class="w-48 h-48 bg-neutral-900 rounded-full flex items-center justify-center relative">
                        <div #platterB class="w-44 h-44 bg-neutral-700 rounded-full border-4 border-neutral-600 cursor-grab active:cursor-grabbing" 
                             [style.transform]="scratchRotationB()"
                             (mousedown)="onScratchStart($event, 'B')" (touchstart)="onScratchStart($event, 'B')">
                            <div class="w-2 h-2 bg-blue-500 rounded-full absolute top-2 left-1/2 -ml-1"></div>
                        </div>
                    </div>
                  </div>
                  <div class="mt-4">
                    <p class="text-sm truncate">{{ deckB().track?.name || 'No Track' }}</p>
                    <div class="flex items-center justify-center gap-4 mt-2">
                      <button (click)="toggleDeckPlay('B')" class="text-2xl"><i [ngClass]="deckB().isPlaying ? 'fa-pause' : 'fa-play'" class="fas"></i></button>
                      <button (click)="playNextOnDeck('B')" class="text-lg"><i class="fas fa-step-forward"></i></button>
                    </div>
                  </div>
                   <audio #audioPlayerB (ended)="onDeckTrackEnded('B')"></audio>
              </div>
          </div>
          <!-- Crossfader & VU Meters -->
          <div class="bg-neutral-900/50 p-2 rounded-md flex items-center gap-4" [ngClass]="djBorderClass()">
              <app-audio-visualizer [analyserNode]="getMasterAnalyser()"></app-audio-visualizer>
              <input type="range" min="-1" max="1" step="0.01" [(ngModel)]="crossfade" class="w-1/3">
              <app-audio-visualizer [analyserNode]="getMasterAnalyser()"></app-audio-visualizer>
          </div>
      </div>
      
      <!-- Other Views -->
      <app-piano-roll *ngIf="mainViewMode() === 'piano-roll'"></app-piano-roll>
      <app-image-editor *ngIf="mainViewMode() === 'image-editor'" [initialPrompt]="imageEditorInitialPrompt()" (imageGenerated)="handleImageGenerated($event)" (imageSelectedForAlbumArt)="handleImageSelectedForAlbumArt($event)"></app-image-editor>
      <app-video-editor *ngIf="mainViewMode() === 'video-editor'" [initialPrompt]="videoEditorInitialPrompt()"></app-video-editor>
      <app-networking *ngIf="mainViewMode() === 'networking'" (artistProfileSelected)="selectedArtistProfile.set($event)"></app-networking>
      <app-profile-editor *ngIf="mainViewMode() === 'profile'"></app-profile-editor>
      <app-hub *ngIf="mainViewMode() === 'tha-spot'"></app-hub>

      <!-- Matrix Background -->
      <app-matrix-background></app-matrix-background>
    </div>

    <!-- Right Sidebar (Chatbot) -->
    <aside *ngIf="showChatbot()" class="w-1/3 max-w-md bg-neutral-900/50 border-l-2" [ngClass]="mainBorderClass()">
      <app-chatbot 
        (transcribe)="videoToAnalyze.set($event)" 
        (generateImage)="mainViewMode.set('image-editor'); imageEditorInitialPrompt.set($event);"
        (generateVideo)="mainViewMode.set('video-editor'); videoEditorInitialPrompt.set($event);"
        (analyzeImage)="imageToAnalyzeUrl.set($event)"
        (mapSearch)="networkingLocationQuery.set($event)"
        (artistSearch)="networkingLocationQuery.set($event)"
        (artistProfileView)="selectedArtistProfile.set($event)">
      </app-chatbot>
    </aside>

    <!-- EQ Panel Modal -->
    <div *ngIf="showEqPanel()" class="absolute top-16 right-0 m-4 z-20">
       <app-eq-panel [initialSettings]="eqSettings()" (settingsChange)="onMasterEqChange($event)"></app-eq-panel>
    </div>
    
    <!-- Apply Album Art Modal -->
    <div *ngIf="showApplyAlbumArtModal()" class="absolute inset-0 bg-black/70 flex items-center justify-center z-30">
      <div class="bg-neutral-800 p-6 rounded-lg shadow-lg">
        <h3 class="text-lg font-bold mb-4">Apply Album Art</h3>
        <p>Apply this image as album art for:</p>
        <div class="flex justify-around mt-4">
          <button (click)="applyImageAsAlbumArt('player')" class="bg-blue-600 hover:bg-blue-500 px-4 py-2 rounded">Main Player</button>
          <button (click)="applyImageAsAlbumArt('A')" class="bg-green-600 hover:bg-green-500 px-4 py-2 rounded">Deck A</button>
          <button (click)="applyImageAsAlbumArt('B')" class="bg-red-600 hover:bg-red-500 px-4 py-2 rounded">Deck B</button>
        </div>
        <button (click)="showApplyAlbumArtModal.set(false)" class="mt-6 text-sm text-neutral-400 hover:underline">Cancel</button>
      </div>
    </div>
  </main>
</div>
